from __future__ import annotations

import timeit
import pstats
import cProfile

import asyncio
import os
import sys
import logging
from typing import Coroutine, List

sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from loguru import logger  # noqa: E402
from xoa_driver.testers import L23Tester  # noqa: E402

from xoa_driver.functions.config_cli_convert import CLIConverter  # noqa: E402


async def test_hli() -> None:
    async with L23Tester("192.168.1.198", "ACO") as tester:
        # t_cap = await tester.capabilities.get()
        # print(t_cap.can_sync_traffic_start)
        module = tester.modules.obtain(1)
        port1 = module.ports.obtain(0)
        port2 = module.ports.obtain(1)
        print(port1, port2)
        print(port1.info.reservation)
        print(port1.info.reserved_by)
        await port1.reservation.set_reserve()
        # print(m1)


def test_config_cli() -> None:
    c_commands = """C_LOGON "xena"
C_OWNER "Bob"
C_OWNER ?
C_KEEPALIVE ?
C_TIMEOUT 100
C_TIMEOUT ?
C_RESERVATION RELEASE
C_RESERVATION ?
C_RESERVEDBY ?
C_LOGOFF
C_DOWN -1480937026 RESTART
C_CAPABILITIES ?
C_MODEL ?
C_SERIALNO ?
C_VERSIONNO ?
C_PORTCOUNTS ?
C_PORTERRORS ?
C_REMOTEPORTCOUNTS ?
C_BUILDSTRING ?
C_NAME "L23 Live Demo"
C_NAME ?
C_COMMENT "this a comment"
C_COMMENT ?
C_PASSWORD "abcd"
C_PASSWORD ?
C_IPADDRESS 192.168.1.100 255.255.255.0 192.168.1.1
C_IPADDRESS ?
C_DHCP OFF
C_DHCP ?
C_MACADDRESS ?
C_HOSTNAME "xena-123456"
C_HOSTNAME ?
C_FLASH OFF
C_FLASH ?
C_DEBUGLOGS ?
C_TEMPERATURE ?
C_RESTPORT 1
C_RESTPORT ?
C_RESTENABLE OFF
C_RESTENABLE ?
C_RESTCONTROL START
C_RESTSTATUS ?
C_WATCHDOG 1
C_WATCHDOG ?
C_INDICES ?
C_STATSESSION [0] ?
# C_TKLICFILE "a string"
C_TKLICFILE ?
C_TKLICSTATE ?
# C_FILESTART 0x01 0x01 0x01020304 0x444 0xedfe4432 "filename"
C_FILEDATA 1 0x1E2E3E4E5E1E2E3E4E5E1E2E3E4E5E1E2E3E4E5E1E2E3E4E5E
C_FILEFINISH
C_TRAFFIC OFF 0 0 0 1
C_VERSIONNO_MINOR ?
C_START 0 0 0 1
C_STOP 0 0 0 1
C_MULTIUSER ?
C_SCRIPT "C_MODEL ?"
C_TKSTATUS ?
C_TKSVCSTATE STOP
C_TKSVCSTATE ?
C_TKGPSSTATE ?
C_TIME ?
C_TRAFFICSYNC OFF 2147483647 0 0 0 1
C_TRAFFICSYNC ?
C_TKSTATUSEXT ?
"""

    m_commands = """0 M_RESERVATION RELEASE
0 M_RESERVATION ? 
0 M_RESERVEDBY ?
0 M_MODEL ?
0 M_SERIALNO ?
0 M_VERSIONNO ?
0 M_STATUS ?
0 M_PORTCOUNT ?
0 M_UPGRADE "image.name"
0 M_UPGRADEPROGRESS ?
0 M_TIMESYNC CHASSIS
0 M_TIMESYNC ?
0 M_CFPTYPE ?
0 M_COMMENT "comment"
0 M_TIMEADJUSTMENT 1
0 M_CAPABILITIES ?
0 M_MEDIASUPPORT ?
0 M_FPGAREIMAGE
0 M_MULTIUSER ?
0 M_CFPCONFIGEXT ?
0 M_CLOCKPPB ?
0 M_SMAINPUT NOTUSED
0 M_SMASTATUS ?
0 M_NAME ?
0 M_REVISION ?
0 M_MEDIA CFP4
0 M_MEDIA ?
0 M_CLOCKSYNCSTATUS ?
0 M_LICENSE_DEMO_INFO ?
0 M_LICENSE_MAINTENANCE_INFO ?
0 M_LICENSE_CWB_DETECTED ?
0 M_LICENSE_UPDATE
0 M_LICENSE_UPDATE_STATUS ?
0 M_LICENSE_LIST_BSON ?
0 M_LICENSE_ONLINE OFFLINE
0 M_TXCLOCKSOURCE_NEW MODULELOCALCLOCK
0 M_TXCLOCKSTATUS_NEW ?
0 M_TXCLOCKFILTER_NEW BW103HZ
0 M_CLOCKPPBSWEEP TRIANGLE 10000 1000000 100000 0
0 M_CLOCKSWEEPSTATUS ?
"""

    p_commands = """
0/1 P_RESERVATION RELEASE
0/1 P_RESERVATION ?
0/1 P_RESERVEDBY ?
0/1 P_RESET
0/1 P_CAPABILITIES ?
0/1 P_INTERFACE ?
0/1 P_SPEEDSELECTION AUTO
0/1 P_SPEEDSELECTION ?
0/1 P_SPEED ?
0/1 P_RECEIVESYNC ?
0/1 P_COMMENT "This is a comment"
0/1 P_COMMENT ?
0/1 P_SPEEDREDUCTION 1
0/1 P_SPEEDREDUCTION ?
0/1 P_INTERFRAMEGAP 1
0/1 P_INTERFRAMEGAP ?
0/1 P_MACADDRESS 0x1234FFFFE1E2
0/1 P_MACADDRESS ?
0/1 P_IPADDRESS 192.168.1.100 255.255.255.0 192.168.1.1 255.255.255.255
0/1 P_IPADDRESS ?
0/1 P_ARPREPLY OFF
0/1 P_ARPREPLY ?
0/1 P_PINGREPLY OFF
0/1 P_PINGREPLY ?
0/1 P_PAUSE OFF
0/1 P_PAUSE ?
0/1 P_RANDOMSEED 1
0/1 P_RANDOMSEED ?
0/1 P_LOOPBACK NONE
0/1 P_LOOPBACK ?
0/1 P_FLASH OFF
0/1 P_FLASH ?
0/1 P_TRAFFIC STOP
0/1 P_TRAFFIC ?
0/1 P_CAPTURE STOP
0/1 P_CAPTURE ?
0/1 P_XMITONE 0x04f4bc19a2a104f4bc19a2a0080045000032000000007fff12b70a0a0a010a0a0a0222232425262728292a2b000000c560b75a001e2280006a7e7f95b0da09c5
0/1 P_LATENCYOFFSET 1
0/1 P_LATENCYOFFSET ? 
0/1 P_LATENCYMODE LAST2LAST
0/1 P_LATENCYMODE ?
0/1 P_AUTOTRAIN 1
0/1 P_AUTOTRAIN ?
0/1 P_UAT_MODE OFF 1
0/1 P_UAT_MODE ?
0/1 P_UAT_FLR 1
0/1 P_UAT_FLR ?
0/1 P_MIXWEIGHTS 0 0 0 0 57 3 5 1 2 5 1 4 4 18 0 0
0/1 P_MIXWEIGHTS ?
0/1 P_MDIXMODE AUTO
0/1 P_MDIXMODE ?
0/1 P_TRAFFICERR ?
0/1 P_GAPMONITOR 1 1
0/1 P_GAPMONITOR ?
0/1 P_CHECKSUM 1
0/1 P_CHECKSUM ?
0/1 P_STATUS ?
0/1 P_AUTONEGSELECTION OFF
0/1 P_AUTONEGSELECTION ?
0/1 P_MIXLENGTH [0] 1
0/1 P_MIXLENGTH [0] ?
0/1 P_ARPRXTABLE 0x0A0A0A0A0018011122334455660B0B0B0B001801998877665544
0/1 P_ARPRXTABLE ?
0/1 P_NDPRXTABLE 0x00000000000000000000000000000123008001112233445566
0/1 P_NDPRXTABLE ?
0/1 P_MULTICAST 192.168.1.100 OFF 1
0/1 P_MULTICAST ?
0/1 P_MULTICASTEXT 192.168.1.100 OFF 1 IGMPV2
0/1 P_MULTICASTEXT ?
0/1 P_MCSRCLIST 192.168.1.100
0/1 P_MCSRCLIST ?
0/1 P_TXMODE NORMAL
0/1 P_TXMODE ?
0/1 P_MULTICASTHDR 1 NOHDR 1 1 OFF
0/1 P_MULTICASTHDR ?
0/1 P_RATEFRACTION 1
0/1 P_RATEFRACTION ?
0/1 P_RATEPPS 1
0/1 P_RATEPPS ?
0/1 P_RATEL2BPS 1
0/1 P_RATEL2BPS ?
0/1 P_PAYLOADMODE NORMAL
0/1 P_PAYLOADMODE ?
0/1 P_BRRMODE SLAVE
0/1 P_BRRMODE ?
0/1 P_TXENABLE OFF
0/1 P_TXENABLE ?
0/1 P_MAXHEADERLENGTH 1
0/1 P_MAXHEADERLENGTH ?
0/1 P_TXTIMELIMIT 1
0/1 P_TXTIMELIMIT ?
0/1 P_TXTIME ?
0/1 P_XMITONETIME ?
0/1 P_IPV6ADDRESS ::1 ::1 1 1
0/1 P_IPV6ADDRESS ?
0/1 P_ARPV6REPLY OFF
0/1 P_ARPV6REPLY ?
0/1 P_PINGV6REPLY OFF
0/1 P_PINGV6REPLY ?
0/1 P_ERRORS ?
0/1 P_TXPREPARE
0/1 P_TXDELAY ?
0/1 P_LPENABLE OFF
0/1 P_LPENABLE ?
0/1 P_LPTXMODE OFF
0/1 P_LPTXMODE ?
0/1 P_LPSTATUS ?
0/1 P_LPPARTNERAUTONEG ?
0/1 P_LPSNRMARGIN ?
0/1 P_LPRXPOWER ?
0/1 P_FAULTSIGNALING NORMAL
0/1 P_FAULTSIGNALING ?
0/1 P_FAULTSTATUS ?
0/1 P_TPLDMODE NORMAL
0/1 P_TPLDMODE ?
0/1 P_LPSUPPORT ?
0/1 P_TXPACKETLIMIT 1 
0/1 P_TXPACKETLIMIT ?
0/1 P_TCVRSTATUS ?
0/1 P_DYNAMIC OFF
0/1 P_DYNAMIC ?
0/1 P_PFCENABLE OFF OFF OFF OFF OFF OFF OFF OFF
0/1 P_PFCENABLE ?
0/1 P_TXBURSTPERIOD 1
0/1 P_TXBURSTPERIOD ?
0/1 P_TXRUNTLENGTH 1
0/1 P_TXRUNTLENGTH ?
0/1 P_RXRUNTLENGTH 1
0/1 P_RXRUNTLENGTH ?
0/1 P_RXRUNTLEN_ERRS ?
0/1 P_TXPREAMBLE_REMOVE OFF
0/1 P_TXPREAMBLE_REMOVE ?
0/1 P_RXPREAMBLE_INSERT OFF
0/1 P_RXPREAMBLE_INSERT ?
0/1 P_SPEEDS_SUPPORTED ?    
"""
    pc_commands = """
0/1 PC_TRIGGER ON 1 FULL 1
0/1 PC_TRIGGER ?
0/1 PC_KEEP ALL 1 1
0/1 PC_KEEP ?
0/1 PC_STATS ?
0/1 PC_EXTRA [0] ?
0/1 PC_PACKET [0] ?
"""
    pd_commands = """
0/1 PD_INDICES 0 1
0/1 PD_INDICES ?
0/1 PD_CREATE [0]
0/1 PD_DELETE [0]
0/1 PD_ENABLE [0] OFF
0/1 PD_ENABLE [0] ?
0/1 PD_SOURCE [0] TXIFG ALL 1
0/1 PD_SOURCE [0] ?
0/1 PD_RANGE [0] 1 1 1
0/1 PD_RANGE [0] ?
0/1 PD_SAMPLES [0] ?    
"""
    pf_commands = """
0/1 PF_INDICES 0 1
0/1 PF_INDICES ?
0/1 PF_CREATE [0]
0/1 PF_DELETE [0]
0/1 PF_ENABLE [0] OFF
0/1 PF_ENABLE [0] ?
0/1 PF_COMMENT [0] 'this is a comment'
0/1 PF_COMMENT [0] ?
0/1 PF_CONDITION [0] 1 1 1 1 1 1
0/1 PF_CONDITION [0] ?
0/1 PF_STRING [0] "a string"
0/1 PF_STRING [0] ?    
"""
    pl_commands = """
0/1 PL_INDICES 0 1
0/1 PL_INDICES ?
0/1 PL_CREATE [0]
0/1 PL_DELETE [0]
0/1 PL_LENGTH [0] AT_MOST 1
0/1 PL_LENGTH [0] ?   
"""
    pm_commands = """
0/1 PM_INDICES 0 1
0/1 PM_INDICES ?
0/1 PM_CREATE [0]
0/1 PM_DELETE [0]
0/1 PM_PROTOCOL [0] ETHERNET VLAN IP -4
0/1 PM_PROTOCOL [0] ?
0/1 PM_POSITION [0] 1
0/1 PM_POSITION [0] ?
0/1 PM_MATCH [0] 0xFF00000000000000 0x0000000000000000
0/1 PM_MATCH [0] ?    
"""
    pp_commands = """
0/1 PP_ALARMS_ERRORS ?
0/1 PP_TXLANECONFIG [0] 1 1
0/1 PP_TXLANECONFIG [0] ?
0/1 PP_TXLANEINJECT [0] HEADERERROR
0/1 PP_TXPRBSCONFIG [0] 1 PRBSOFF ERRORSOFF
0/1 PP_TXPRBSCONFIG [0] ?
0/1 PP_TXERRORRATE 1
0/1 PP_TXERRORRATE ?
0/1 PP_TXINJECTONE
0/1 PP_RXTOTALSTATS ?
0/1 PP_RXFECSTATS ?
0/1 PP_LINKFLAP_PARAMS 1 1 1
0/1 PP_LINKFLAP_PARAMS ?
0/1 PP_LINKFLAP_ENABLE OFF
0/1 PP_LINKFLAP_ENABLE ?
0/1 PP_PMAERRPUL_PARAMS 1 1 1 1 1
0/1 PP_PMAERRPUL_PARAMS ?
0/1 PP_RXLANELOCK [0] ?
0/1 PP_RXLANESTATUS [0] ?
0/1 PP_RXLANEERRORS [0] ?
0/1 PP_RXPRBSSTATUS [0] ?
0/1 PP_RXCLEAR
0/1 PP_RXLASERPOWER ?
0/1 PP_TXLASERPOWER ?
0/1 PP_PMAERRPUL_ENABLE OFF
0/1 PP_PMAERRPUL_ENABLE ?
0/1 PP_EYEMEASURE [0] STOP 0
0/1 PP_EYEMEASURE [0] ?
0/1 PP_EYERESOLUTION [0] 1 1
0/1 PP_EYERESOLUTION [0] ?
0/1 PP_EYEREAD [0, 0] ?
0/1 PP_EYEINFO [0] ? 
0/1 PP_PHYTXEQ [0] 0 128 0 0 0 0 4 2
0/1 PP_PHYTXEQ [0] ?
0/1 PP_PHYRETUNE [0] 1
0/1 PP_PHYAUTOTUNE [0] OFF
0/1 PP_PHYAUTOTUNE [0] ?
0/1 PP_EYEBER [0] ?
0/1 PP_PHYAUTONEG OFF 1 1 1 1
0/1 PP_PHYAUTONEG ?
0/1 PP_TXPRBSTYPE CAUI_VIRTUAL PRBS7 NON_INVERTED
0/1 PP_TXPRBSTYPE ?
0/1 PP_RXPRBSTYPE CAUI_VIRTUAL PRBS7 NON_INVERTED ACCUMULATIVE
0/1 PP_RXPRBSTYPE ?
0/1 PP_FECMODE OFF
0/1 PP_FECMODE ?
0/1 PP_EYEDWELLBITS [0] 1 1
0/1 PP_EYEDWELLBITS [0] ?
0/1 PP_PHYSIGNALSTATUS ?
0/1 PP_PRBSTYPE CAUI_VIRTUAL PRBS7 NON_INVERTED ACCUMULATIVE
0/1 PP_PRBSTYPE ?
0/1 PP_PHYSETTINGS OFF OFF OFF OFF
0/1 PP_PHYSETTINGS ?
0/1 PP_PHYRXEQ [0] 1 1 1
0/1 PP_PHYRXEQ [0] ?
0/1 PP_AUTONEG ANEG_OFF DEFAULT_TECH_MODE DEFAULT_FEC DEFAULT_FEC NO_PAUSE
0/1 PP_AUTONEG ?
0/1 PP_AUTONEGSTATUS ?
# 0/1 PP_LINKTRAIN AUTO P16K_FRAME NO_INIT NRZ_NO_PRESET DEFAULT_TIMEOUT
0/1 PP_LINKTRAIN ?
0/1 PP_LINKTRAINSTATUS [0] ?    
"""
    for c in CLIConverter.read_commands_from_long_string(
        c_commands
        + m_commands
        + p_commands
        + pc_commands
        + pd_commands
        + pf_commands
        + pl_commands
        + pm_commands
        + pp_commands
    ):
        print(c)
        print(c.as_request())


def run(method: Coroutine) -> None:
    import platform

    if platform.system() == "Windows":
        asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())
    asyncio.run(method)


if __name__ == "__main__":
    # run(test_hli())
    test_config_cli()
    # result = timeit.timeit(
    #     "run(main())",
    #     setup="from __main__ import run, main",
    #     number=10
    # )
    # print(result)
